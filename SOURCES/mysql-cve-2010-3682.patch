Back-ported patch for upstream bug #52711.


diff -Naur mysql-5.0.77.orig/mysql-test/r/subselect.result mysql-5.0.77/mysql-test/r/subselect.result
--- mysql-5.0.77.orig/mysql-test/r/subselect.result	2009-01-29 17:38:25.000000000 -0500
+++ mysql-5.0.77/mysql-test/r/subselect.result	2010-10-22 18:33:12.265135832 -0400
@@ -4453,3 +4453,20 @@
 DROP VIEW v1,v2,v3;
 DROP TABLE t1,t2;
 End of 5.0 tests.
+#
+# Bug #52711: Segfault when doing EXPLAIN SELECT with 
+#  union...order by (select... where...)
+#
+CREATE TABLE t1 (a VARCHAR(10), FULLTEXT KEY a (a));
+INSERT INTO t1 VALUES (1),(2);
+CREATE TABLE t2 (b INT);
+INSERT INTO t2 VALUES (1),(2);
+# Should not crash
+EXPLAIN
+SELECT * FROM t2 UNION SELECT * FROM t2
+ORDER BY (SELECT * FROM t1 WHERE MATCH(a) AGAINST ('+abc' IN BOOLEAN MODE));
+# Should not crash
+SELECT * FROM t2 UNION SELECT * FROM t2
+ORDER BY (SELECT * FROM t1 WHERE MATCH(a) AGAINST ('+abc' IN BOOLEAN MODE));
+DROP TABLE t1,t2;
+End of 5.1 tests
diff -Naur mysql-5.0.77.orig/mysql-test/t/subselect.test mysql-5.0.77/mysql-test/t/subselect.test
--- mysql-5.0.77.orig/mysql-test/t/subselect.test	2009-01-29 17:38:01.000000000 -0500
+++ mysql-5.0.77/mysql-test/t/subselect.test	2010-10-22 18:33:12.266189897 -0400
@@ -3361,3 +3361,27 @@
 DROP TABLE t1,t2;
 
 --echo End of 5.0 tests.
+
+--echo #
+--echo # Bug #52711: Segfault when doing EXPLAIN SELECT with 
+--echo #  union...order by (select... where...)
+--echo #
+
+CREATE TABLE t1 (a VARCHAR(10), FULLTEXT KEY a (a));
+INSERT INTO t1 VALUES (1),(2);
+CREATE TABLE t2 (b INT);
+INSERT INTO t2 VALUES (1),(2);
+
+--echo # Should not crash
+--disable_result_log
+EXPLAIN
+SELECT * FROM t2 UNION SELECT * FROM t2
+  ORDER BY (SELECT * FROM t1 WHERE MATCH(a) AGAINST ('+abc' IN BOOLEAN MODE));
+
+--echo # Should not crash
+SELECT * FROM t2 UNION SELECT * FROM t2
+  ORDER BY (SELECT * FROM t1 WHERE MATCH(a) AGAINST ('+abc' IN BOOLEAN MODE));
+DROP TABLE t1,t2;
+--enable_result_log
+
+--echo End of 5.1 tests
diff -Naur mysql-5.0.77.orig/sql/sql_select.cc mysql-5.0.77/sql/sql_select.cc
--- mysql-5.0.77.orig/sql/sql_select.cc	2009-01-29 16:45:34.000000000 -0500
+++ mysql-5.0.77/sql/sql_select.cc	2010-10-22 18:34:01.080989825 -0400
@@ -501,7 +501,7 @@
     thd->lex->allow_sum_func= save_allow_sum_func;
   }
 
-  if (!thd->lex->view_prepare_mode)
+  if (!thd->lex->view_prepare_mode && !(select_options & SELECT_DESCRIBE))
   {
     Item_subselect *subselect;
     /* Is it subselect? */
@@ -6708,7 +6708,8 @@
       *simple_order=0;				// Must do a temp table to sort
     else if (!(order_tables & not_const_tables))
     {
-      if (order->item[0]->with_subselect)
+      if (order->item[0]->with_subselect && 
+          !(join->select_lex->options & SELECT_DESCRIBE))
         order->item[0]->val_str(&order->item[0]->str_value);
       DBUG_PRINT("info",("removing: %s", order->item[0]->full_name()));
       continue;					// skip const item
