Back-ported patch for upstream bug #51875.


diff -Naur mysql-5.0.77.orig/mysql-test/r/gis.result mysql-5.0.77/mysql-test/r/gis.result
--- mysql-5.0.77.orig/mysql-test/r/gis.result	2009-01-29 17:38:14.000000000 -0500
+++ mysql-5.0.77/mysql-test/r/gis.result	2010-10-22 14:52:08.365920363 -0400
@@ -972,3 +972,11 @@
 NULL
 drop table t1;
 End of 5.0 tests
+#
+# BUG#51875: crash when loading data into geometry function polyfromwkb
+#
+SET @a=0x00000000030000000100000000000000000000000000144000000000000014400000000000001840000000000000184000000000000014400000000000001440;
+SET @a=POLYFROMWKB(@a);
+SET @a=0x00000000030000000000000000000000000000000000144000000000000014400000000000001840000000000000184000000000000014400000000000001440;
+SET @a=POLYFROMWKB(@a);
+End of 5.1 tests
diff -Naur mysql-5.0.77.orig/mysql-test/t/gis.test mysql-5.0.77/mysql-test/t/gis.test
--- mysql-5.0.77.orig/mysql-test/t/gis.test	2009-01-29 17:37:51.000000000 -0500
+++ mysql-5.0.77/mysql-test/t/gis.test	2010-10-22 14:52:46.125918997 -0400
@@ -652,3 +652,14 @@
 drop table t1;
 
 --echo End of 5.0 tests
+
+--echo #
+--echo # BUG#51875: crash when loading data into geometry function polyfromwkb
+--echo #
+SET @a=0x00000000030000000100000000000000000000000000144000000000000014400000000000001840000000000000184000000000000014400000000000001440;
+SET @a=POLYFROMWKB(@a);
+SET @a=0x00000000030000000000000000000000000000000000144000000000000014400000000000001840000000000000184000000000000014400000000000001440;
+SET @a=POLYFROMWKB(@a);
+
+
+--echo End of 5.1 tests
diff -Naur mysql-5.0.77.orig/sql/spatial.cc mysql-5.0.77/sql/spatial.cc
--- mysql-5.0.77.orig/sql/spatial.cc	2009-01-29 16:45:31.000000000 -0500
+++ mysql-5.0.77/sql/spatial.cc	2010-10-22 14:50:50.486989959 -0400
@@ -519,7 +519,7 @@
   n_points= wkb_get_uint(wkb, bo);
   proper_length= 4 + n_points * POINT_DATA_SIZE;
 
-  if (len < proper_length || res->reserve(proper_length))
+  if (!n_points || len < proper_length || res->reserve(proper_length))
     return 0;
 
   res->q_append(n_points);
@@ -737,7 +737,9 @@
   if (len < 4)
     return 0;
 
-  n_linear_rings= wkb_get_uint(wkb, bo);
+  if (!(n_linear_rings= wkb_get_uint(wkb, bo)))
+    return 0;
+
   if (res->reserve(4, 512))
     return 0;
   wkb+= 4;
