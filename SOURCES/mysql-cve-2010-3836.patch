Back-ported patch for upstream bug #54568.


diff -Naur mysql-5.0.77.orig/mysql-test/r/subselect3.result mysql-5.0.77/mysql-test/r/subselect3.result
--- mysql-5.0.77.orig/mysql-test/r/subselect3.result	2009-01-29 17:38:25.000000000 -0500
+++ mysql-5.0.77/mysql-test/r/subselect3.result	2010-10-22 16:25:56.856989319 -0400
@@ -796,3 +796,22 @@
 varchar_nokey
 DROP TABLE t1;
 End of 5.0 tests
+#
+# Bug#54568: create view cause Assertion failed: 0, 
+# file .\item_subselect.cc, line 836
+#
+EXPLAIN SELECT 1 LIKE ( 1 IN ( SELECT 1 ) );
+id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
+1	PRIMARY	NULL	NULL	NULL	NULL	NULL	NULL	NULL	No tables used
+Warnings:
+Note	1249	Select 2 was reduced during optimization
+DESCRIBE SELECT 1 LIKE ( 1 IN ( SELECT 1 ) );
+id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
+1	PRIMARY	NULL	NULL	NULL	NULL	NULL	NULL	NULL	No tables used
+Warnings:
+Note	1249	Select 2 was reduced during optimization
+# None of the below should crash
+CREATE VIEW v1 AS SELECT 1 LIKE ( 1 IN ( SELECT 1 ) );
+CREATE VIEW v2 AS SELECT 1 LIKE '%' ESCAPE ( 1 IN ( SELECT 1 ) );
+DROP VIEW v1, v2;
+# End of 5.1 tests.
diff -Naur mysql-5.0.77.orig/mysql-test/t/subselect3.test mysql-5.0.77/mysql-test/t/subselect3.test
--- mysql-5.0.77.orig/mysql-test/t/subselect3.test	2009-01-29 17:38:01.000000000 -0500
+++ mysql-5.0.77/mysql-test/t/subselect3.test	2010-10-22 16:24:56.302076215 -0400
@@ -641,3 +641,16 @@
 DROP TABLE t1;
 
 --echo End of 5.0 tests
+
+--echo #
+--echo # Bug#54568: create view cause Assertion failed: 0, 
+--echo # file .\item_subselect.cc, line 836
+--echo #
+EXPLAIN SELECT 1 LIKE ( 1 IN ( SELECT 1 ) );
+DESCRIBE SELECT 1 LIKE ( 1 IN ( SELECT 1 ) );
+--echo # None of the below should crash
+CREATE VIEW v1 AS SELECT 1 LIKE ( 1 IN ( SELECT 1 ) );
+CREATE VIEW v2 AS SELECT 1 LIKE '%' ESCAPE ( 1 IN ( SELECT 1 ) );
+DROP VIEW v1, v2;
+
+--echo # End of 5.1 tests.
diff -Naur mysql-5.0.77.orig/sql/item_cmpfunc.cc mysql-5.0.77/sql/item_cmpfunc.cc
--- mysql-5.0.77.orig/sql/item_cmpfunc.cc	2009-01-29 16:45:26.000000000 -0500
+++ mysql-5.0.77/sql/item_cmpfunc.cc	2010-10-22 16:24:56.304067233 -0400
@@ -4243,7 +4243,7 @@
     return TRUE;
   }
   
-  if (escape_item->const_item())
+  if (escape_item->const_item() && !thd->lex->view_prepare_mode)
   {
     /* If we are on execution stage */
     String *escape_str= escape_item->val_str(&tmp_value1);
