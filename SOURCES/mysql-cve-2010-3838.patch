Back-ported patch for upstream bug #54461.
This must be applied after mysql-name-const.patch.


diff -Naur mysql-5.0.77.nameconst/mysql-test/r/func_misc.result mysql-5.0.77/mysql-test/r/func_misc.result
--- mysql-5.0.77.nameconst/mysql-test/r/func_misc.result	2010-10-22 15:42:33.600990203 -0400
+++ mysql-5.0.77/mysql-test/r/func_misc.result	2010-10-22 15:43:23.698987793 -0400
@@ -325,3 +325,19 @@
 a
 DROP TABLE t1;
 End of 5.0 tests
+#
+# Bug #54461: crash with longblob and union or update with subquery
+#
+CREATE TABLE t1 (a INT, b LONGBLOB);
+INSERT INTO t1 VALUES (1, '2'), (2, '3'), (3, '2');
+SELECT DISTINCT LEAST(a, (SELECT b FROM t1 LIMIT 1)) FROM t1 UNION SELECT 1;
+LEAST(a, (SELECT b FROM t1 LIMIT 1))
+1
+2
+SELECT DISTINCT GREATEST(a, (SELECT b FROM t1 LIMIT 1)) FROM t1 UNION SELECT 1;
+GREATEST(a, (SELECT b FROM t1 LIMIT 1))
+2
+3
+1
+DROP TABLE t1;
+End of 5.1 tests
diff -Naur mysql-5.0.77.nameconst/mysql-test/t/func_misc.test mysql-5.0.77/mysql-test/t/func_misc.test
--- mysql-5.0.77.nameconst/mysql-test/t/func_misc.test	2010-10-22 15:42:33.600990203 -0400
+++ mysql-5.0.77/mysql-test/t/func_misc.test	2010-10-22 15:43:23.699988444 -0400
@@ -447,3 +447,16 @@
 
 --echo End of 5.0 tests
 
+--echo #
+--echo # Bug #54461: crash with longblob and union or update with subquery
+--echo #
+
+CREATE TABLE t1 (a INT, b LONGBLOB);
+INSERT INTO t1 VALUES (1, '2'), (2, '3'), (3, '2');
+
+SELECT DISTINCT LEAST(a, (SELECT b FROM t1 LIMIT 1)) FROM t1 UNION SELECT 1;
+SELECT DISTINCT GREATEST(a, (SELECT b FROM t1 LIMIT 1)) FROM t1 UNION SELECT 1;
+
+DROP TABLE t1;
+
+--echo End of 5.1 tests
diff -Naur mysql-5.0.77.nameconst/sql/item_func.cc mysql-5.0.77/sql/item_func.cc
--- mysql-5.0.77.nameconst/sql/item_func.cc	2009-01-29 16:45:26.000000000 -0500
+++ mysql-5.0.77/sql/item_func.cc	2010-10-22 15:43:23.701921884 -0400
@@ -2251,6 +2251,8 @@
   else if ((cmp_type == DECIMAL_RESULT) || (cmp_type == INT_RESULT))
     max_length= my_decimal_precision_to_length(max_int_part+decimals, decimals,
                                             unsigned_flag);
+  else if (cmp_type == REAL_RESULT)
+    max_length= float_length(decimals);
   cached_field_type= agg_field_type(args, arg_count);
 }
 
