Back-ported patch for upstream bug #55564.

--- mysql-5.0.91/mysql-test/r/user_var.result.orig	2010-05-05 09:31:07.000000000 -0500
+++ mysql-5.0.91/mysql-test/r/user_var.result	2010-11-10 14:15:50.673712293 -0600
@@ -379,3 +379,21 @@
 10	NULL
 DROP TABLE t1, t2, t3;
 End of 5.0 tests
+CREATE TABLE t1(a INT);
+INSERT INTO t1 VALUES (0),(0);
+# BUG#55615 : should not crash
+SELECT (@a:=(SELECT @a:=1 FROM t1 LIMIT 1)) AND COUNT(1) FROM t1 GROUP BY @a;
+(@a:=(SELECT @a:=1 FROM t1 LIMIT 1)) AND COUNT(1)
+1
+1
+# BUG#55564 : should not crash
+SELECT IF(
+@v:=LEAST((SELECT 1 FROM t1 t2 LEFT JOIN t1 ON (@v) GROUP BY t1.a), a),
+count(*), 1) 
+FROM t1 GROUP BY a LIMIT 1;
+IF(
+@v:=LEAST((SELECT 1 FROM t1 t2 LEFT JOIN t1 ON (@v) GROUP BY t1.a), a),
+count(*), 1)
+1
+DROP TABLE t1;
+End of 5.1 tests
--- mysql-5.0.91/mysql-test/t/user_var.test.orig	2010-05-05 09:31:02.000000000 -0500
+++ mysql-5.0.91/mysql-test/t/user_var.test	2010-11-10 14:16:28.249480766 -0600
@@ -269,3 +269,23 @@
 DROP TABLE t1, t2, t3;
 
 --echo End of 5.0 tests
+
+#
+# Bug #55615: debug assertion after using variable in assignment and
+# referred to
+# Bug #55564: crash with user variables, assignments, joins...
+#
+
+CREATE TABLE t1(a INT);
+INSERT INTO t1 VALUES (0),(0);
+--echo # BUG#55615 : should not crash
+SELECT (@a:=(SELECT @a:=1 FROM t1 LIMIT 1)) AND COUNT(1) FROM t1 GROUP BY @a;
+--echo # BUG#55564 : should not crash
+SELECT IF(
+  @v:=LEAST((SELECT 1 FROM t1 t2 LEFT JOIN t1 ON (@v) GROUP BY t1.a), a),
+  count(*), 1) 
+FROM t1 GROUP BY a LIMIT 1;
+
+DROP TABLE t1;
+
+--echo End of 5.1 tests
--- mysql-5.0.91/sql/item_func.cc.orig	2010-11-10 14:14:14.497826094 -0600
+++ mysql-5.0.91/sql/item_func.cc	2010-11-10 14:17:51.264641424 -0600
@@ -4281,6 +4281,15 @@
   return entry->val_int(&null_value);
 }
 
+bool Item_func_set_user_var::val_bool_result()
+{
+  DBUG_ASSERT(fixed == 1);
+  check(TRUE);
+  update();                                    // Store expression
+  return entry->val_int(&null_value) != 0;
+}
+
+
 String *Item_func_set_user_var::val_str(String *str)
 {
   DBUG_ASSERT(fixed == 1);
--- mysql-5.0.91/sql/item_func.h.orig	2010-05-05 09:07:04.000000000 -0500
+++ mysql-5.0.91/sql/item_func.h	2010-11-10 14:18:27.648161655 -0600
@@ -1300,6 +1300,7 @@
   my_decimal *val_decimal(my_decimal *);
   double val_result();
   longlong val_int_result();
+  bool val_bool_result();
   String *str_result(String *str);
   my_decimal *val_decimal_result(my_decimal *);
   bool is_null_result();
